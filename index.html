<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRj4frRRj12rs9PbuIxwY6h6xyJHbxno1CQCUl2_fTek-CvKPnYYVwCZoa0t47qB-yzKSJKhU18dYcZ/pub?output=csv';

    function parseNumber(val) {
        if (val === undefined || val === null || val === '') return 0;
        // This regex removes everything EXCEPT numbers, dots, and minus signs
        const clean = val.toString().replace(/[^0-9.-]/g, '');
        const num = parseFloat(clean);
        return isNaN(num) ? 0 : num;
    }

    function init() {
        Papa.parse(SHEET_URL, {
            download: true,
            header: false,
            complete: function(results) {
                renderDashboard(results.data);
            }
        });
    }

    function renderDashboard(rows) {
        const marketAnswer = rows[0][4]; 
        const answerEl = document.getElementById('market-answer');
        answerEl.innerText = marketAnswer ? marketAnswer.toUpperCase() : "N/A";
        
        if(marketAnswer && marketAnswer.toLowerCase().includes('yes')) {
            answerEl.style.color = '#33ff33';
        } else {
            answerEl.style.color = '#ff3333';
        }

        let tickers = [];
        let weights = [];
        let changes = [];
        let textLabels = [];

        // Loop from Row 4 (index 3) downwards
        for (let i = 3; i < rows.length; i++) {
            const row = rows[i];
            const ticker = row[0];
            const weightVal = row[3];
            const changeVal = row[4];

            // Only add if there is a ticker name and at least one value
            if (ticker && ticker.trim() !== "" && (weightVal || changeVal)) {
                const weight = parseNumber(weightVal);
                const change = parseNumber(changeVal);

                tickers.push(ticker);
                weights.push(weight > 0 ? weight : 0.1); // Ensure tile has at least tiny size
                changes.push(change);
                textLabels.push(`${ticker}<br>Change: ${change}%`);
            }
        }

        const plotData = [{
            type: 'treemap',
            labels: tickers,
            parents: tickers.map(() => ""),
            values: weights,
            marker: {
                colors: changes,
                colorscale: [
                    [0, '#ff3333'],   // Red
                    [0.5, '#222222'], // Dark Grey/Black at 0%
                    [1, '#33ff33']    // Green
                ],
                cmid: 0,
                line: { width: 1, color: '#000' }
            },
            texttemplate: "<b>%{label}</b><br>%{color:.2f}%",
            hoverinfo: "text",
            textfont: { family: 'Courier New', color: '#fff' }
        }];

        const layout = {
            margin: {t: 0, l: 0, r: 0, b: 0},
            paper_bgcolor: '#000',
            plot_bgcolor: '#000'
        };

        document.getElementById('loading').style.display = 'none';
        Plotly.newPlot('chart-container', plotData, layout, {responsive: true, displayModeBar: false});
    }

    init();
</script>
